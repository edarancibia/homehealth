<div th:include="cabecera-paciente.html" th:remove="tag"></div>

<div class="container">
    <div class="col-md-12 ancho-bordes">
        <p>Evolución de Enfermería</p>
        <button type="button" data-target="#modalEvEnfermeria" data-toggle="modal" id="btnAddEvEnfermeria" class="btn btn-small"><i class="fas fa-plus-circle"></i> Agregar</button>
        <a th:href="@{'/menu/'+ ${idficha}}" class="btn btn-small"><i class="fas fa-undo-alt"></i> Volver al Menú</a>
        <a th:href="@{'/evolucion-e/export/'+ ${idficha}}" type="button" target="_blank" class="btn btn-small">Imprimir <i class="fas fa-file-pdf"></i></a>

        <table class="table table-striped tabla-ev" id="tabla-evEnfermeria">
            <thead></thead>
        </table>
    </div>
</div>

</body>
<div class="modal fade" id="modalEvEnfermeria" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" >
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Registrar Evolución</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label class="col-xs-2 control-label labels-text">Evolución</label>
          <textarea id="txtEvolucionE" cols="30" rows="5" class="form-control input-text" style="height: 50%;"></textarea>
          <input type='hidden' id='postid' value='0' >
          <button type="text" class="form-control" onclick='startRecording();'><i class="fas fa-microphone"></i></button>
        </div>
        <div class="modal-footer">
          <button type="button" id="btnSaveEvEnfermeria" class="btn btn-primary" data-dismiss="modal">Guardar</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
      $(document).ready(function(){
        
        if($('#txtRoleSession').val() != 'ENF'){
            $('#btnSaveEvEnfermeria').attr('disabled',true);
        }

        var base_url = 'https://hhosorno.herokuapp.com/';
        //var base_url = 'http://localhost:8080/';
        var idficha = $('#txtHiddenFicha').val();

        $.ajax({
            type: 'get',
            url: base_url + 'evolucion-e/list/' + idficha,
            success: function(data){
                $("#tabla-evEnfermeria thead").append("<th>Fecha</th><th>Evolución</th><th>Usuario</th>");
				        $('#tabla-evEnfermeria tr').remove();
                $.each(data, function(i, item){
					        $('<tr>').html(
                        "<td>"+data[i].fecha+"</td>" +
                        "<td>"+data[i].descripcion+"</td>" +
                        "<td>"+data[i].usuario+"</td>"+
                    "</tr>").appendTo('#tabla-evEnfermeria');
                });
            }
        });

        var timer;
        var timeout = 3000; // Timout duration
        $('#txtEvolucionE').keyup(function(){
          
          if(timer) {
            clearTimeout(timer);
          }
          
          timer = setTimeout(saveData, timeout); 
          
        });
          
        $('#submit').click(function(){
          saveData();
        });
      });

      // Save data
    function saveData(){
    
    var base_url = 'https://hhosorno.herokuapp.com/';
    //var base_url = 'http://localhost:8080/';
    var postid = $('#postid').val();
    var content = $('#txtEvolucionE').val().trim();

    var form_evolucion_e = {
        'postid'     : postid,
        'idFicha'    : $('#txtHiddenFicha').val(),
        'fecha'      : new Date(),
        'descripcion': $('#txtEvolucionE').val(),
        'rutUsu'     : $('#txtRutSession').val()
    }

    if(content != ''){
      // AJAX request
      $.ajax({
        type: 'post',
        url: base_url+'evolucion-e/autosave',
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        data: JSON.stringify({idEvolucionEnf: postid,idFicha:$('#txtHiddenFicha').val(),fecha:new Date(),descripcion:$('#txtEvolucionE').val(),rutUsu:$('#txtRutSession').val()}),
        //data: {idEvolucionKine: postid,idFicha:$('#txtHiddenFicha').val(),fecha:new Date(),descripcion:$('#txtEvolucionK').val(),rutUsu:$('#txtRutSession').val()},
        success: function(response){
          console.log('datos: '+JSON.stringify(response));
          if (response.hasOwnProperty("idEvolucionEnf")){
              console.log('idevolucion '+response.idEvolucionEnf);
              $('#postid').val(response.idEvolucionEnf);             
          }
        } 
      });
    } 
    //console.log(content);
  }

          //voice
          var recognition = new webkitSpeechRecognition();

          recognition.onresult = function(event) { 
            var saidText = "";
            for (var i = event.resultIndex; i < event.results.length; i++) {
              if (event.results[i].isFinal) {
                saidText = event.results[i][0].transcript;
              } else {
                saidText += event.results[i][0].transcript;
              }
            }
            // Update Textbox value
            document.getElementById('txtEvolucionE').value = saidText;

            // Search Posts
            searchPosts(saidText);
          }

          function startRecording(){
            recognition.start();
          }

  </script>
</html>